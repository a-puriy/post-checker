# Dify起動後の自動初期セットアップ設計

## 目的

**開発者が `npm run start` でDifyを起動した後、初回セットアップを手動で行う手間を解消するため**

現状では、Difyを初めて起動した際に `http://localhost/install` にリダイレクトされ、管理者アカウントの作成を手動で行う必要がある。これを自動化することで、開発環境の構築を効率化する。

## 設計スコープ

- `npm run start` コマンドの拡張（Docker Compose起動後の処理追加）
- Playwrightを使った初期セットアップの自動化

## 現状の動作

```
npm run start
  ↓
cd dify-local/docker && docker compose up -d
  ↓
✅ Dify started: http://localhost/apps
```

## 目標とする動作

```
npm run start
  ↓
cd dify-local/docker && docker compose up -d
  ↓
(Difyの起動完了を待機)
  ↓
http://localhost にアクセス
  ↓
/install にリダイレクトされた場合:
  - 自動で初期セットアップを実行
  - アカウント情報: email=user1@example.com, password=user1@example.com, username=user1
/apps にリダイレクトされた場合:
  - セットアップ済みと判断し、スキップ
  ↓
✅ Dify started: http://localhost/apps
```

## 実装方針

### 新規ファイル

`scripts/src/usecase/setup-dify.ts` を作成

- 既存の `playwright-auth.ts` を参考にPlaywrightでブラウザを操作
- セットアップ済み（/appsに遷移）ならスキップ、/installにリダイレクトされたらセットアップを実行

### 処理フロー

```
1. chromiumを起動（headless: true）
2. http://localhost にアクセス
3. URLを確認
   - /install にリダイレクトした場合 → セットアップ処理へ
   - /apps や /signin にリダイレクトした場合 → セットアップ済みとして終了
4. セットアップ処理（/installの場合のみ）
   - email: user1@example.com
   - name（username）: user1
   - password: user1@example.com
   - フォームを入力してSubmit
   - /apps への遷移を待機
5. ブラウザを閉じる
```

### package.json の変更

`start` スクリプトを以下のように変更:

```json
"start": "cd dify-local/docker && docker compose up -d && tsx scripts/setup-dify.ts && echo '\n✅ Dify started: http://localhost/apps\n'"
```

または、専用のセットアップCLIコマンドを作成:

```json
"start": "cd dify-local/docker && docker compose up -d && tsx scripts/dify-cli.ts setup && echo '\n✅ Dify started: http://localhost/apps\n'"
```

### dify-cli.ts への統合

既存のCLIに `setup` コマンドを追加する形式を推奨:

```
dify-cli setup    # Difyの初期セットアップを実行（未セットアップの場合のみ）
```

## 設定値

以下の値をハードコード:

| 項目 | 値 |
|------|-----|
| baseUrl | `http://localhost` |
| email | `user1@example.com` |
| password | `user1@example.com` |
| username | `user1` |

## Dify install画面のフォーム要素（想定）

Difyの `/install` ページには以下のフォームフィールドがある:

- Email入力フィールド
- Name（ユーザー名）入力フィールド
- Password入力フィールド
- Submitボタン

※実際の要素名・セレクタは実装時に確認が必要

## エラーハンドリング

1. **Difyが起動していない場合**: 接続エラーをキャッチし、リトライ（最大30秒程度待機）
2. **セットアップが失敗した場合**: エラーメッセージを表示して終了（exit code 1）
3. **タイムアウト**: 60秒以内にセットアップが完了しない場合はエラー

## ファイル構成（変更後）

```
scripts/
├── dify-cli.ts                    # CLIエントリポイント（setupコマンド追加）
└── src/
    ├── auth/
    │   └── playwright-auth.ts     # 既存（変更なし）
    └── usecase/
        ├── export-dsl.ts          # 既存（変更なし）
        ├── setup-dify.ts          # 新規: 初期セットアップ処理
        └── ...
```
