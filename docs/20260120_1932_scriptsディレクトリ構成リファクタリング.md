# scripts ディレクトリ構成リファクタリング設計

## 目的

開発者が `scripts/src/` 以下のコードを保守・拡張する際に、各ファイルの責務と依存関係を直感的に理解できるようにするため。

## 現状の課題

1. **ファイル名が曖昧**: `knowledge.ts`, `console.ts` だけでは何のクライアントか不明
2. **usecaseの命名規則が不統一**: `sync.ts`, `diff.ts` など、usecaseであることが名前から読み取れない
3. **diff.ts の配置が不適切**: 純粋なドメインロジックがusecase層に混在している
4. **貧血ドメインモデル**: ロジックがusecase側に散らばり、型定義（types.ts）がただのデータ構造になっている

## 設計方針

- DDD（ドメイン駆動設計）の構成を採用
- リッチなドメインモデルでビジネスロジックをドメイン層に閉じ込める
- Dify専用ツールのため依存性逆転（抽象化）は行わない
- usecaseは現状の関数ベースを維持（クラス化は今回スコープ外）

## 変更後のディレクトリ構成

```
scripts/src/
├── infra/
│   ├── difyConsoleClient.ts    # renamed from client/console.ts
│   ├── difyKnowledgeClient.ts  # renamed from client/knowledge.ts
│   └── types.ts                # Dify APIレスポンス型、クライアントオプション
├── domain/
│   ├── models/
│   │   ├── localDocument.ts    # ローカルファイルのドメインモデル
│   │   ├── difyDocument.ts     # Difyドキュメントのドメインモデル
│   │   └── syncResult.ts       # 同期結果のドメインモデル
│   └── services/
│       └── documentDiffService.ts  # 差分計算ロジック
├── application/
│   ├── setupDifyUsecase.ts     # renamed from usecase/setup-dify.ts
│   ├── syncUsecase.ts          # renamed from usecase/sync.ts
│   ├── exportDslUsecase.ts     # renamed from usecase/export-dsl.ts
│   ├── importDslUsecase.ts     # renamed from usecase/import-dsl.ts
│   └── types.ts                # SyncConfig, DatasetConfig（設定・DTO）
└── (types.ts 廃止)
```

## 各層の責務

### infra層（Infrastructure）
- 外部API（Dify）との通信のみを担当
- HTTPリクエスト/レスポンスの処理
- リトライ、エラーハンドリング
- **types.ts**: Dify APIのレスポンス型（`DifyDocumentListResponse` 等）、クライアントオプション型

### domain層

#### domain/models/
ビジネスロジックを持つリッチなドメインモデル。

**localDocument.ts**
```
- ファイル読み込み時にハッシュを自動計算
- ファイル名のバリデーション
```

**difyDocument.ts**
```
- Dify APIレスポンスからの変換
- インデックス状態の判定ロジック（completed / error / pending）
```

**syncResult.ts**
```
- 同期結果の集計ロジック
- エラー追加メソッド
```

#### domain/services/
複数のドメインモデルをまたぐビジネスロジック。

**documentDiffService.ts**
```
- LocalDocument と DifyDocument の比較
- 差分アクション（create / update / delete / skip）の決定
- 現在の diff.ts から移動
```

### application層
- ドメインモデル・サービスとinfra層を組み合わせたオーケストレーション
- ファイルI/O、API呼び出しなどの副作用を伴う処理
- 進捗ログ出力
- **types.ts**: 設定ファイルの型（`SyncConfig`, `DatasetConfig`）、DTO

## ファイル名変更一覧

| 変更前 | 変更後 |
|--------|--------|
| `client/console.ts` | `infra/difyConsoleClient.ts` |
| `client/knowledge.ts` | `infra/difyKnowledgeClient.ts` |
| `usecase/setup-dify.ts` | `application/setupDifyUsecase.ts` |
| `usecase/sync.ts` | `application/syncUsecase.ts` |
| `usecase/export-dsl.ts` | `application/exportDslUsecase.ts` |
| `usecase/import-dsl.ts` | `application/importDslUsecase.ts` |
| `usecase/diff.ts` | `domain/services/documentDiffService.ts` |
| `types.ts` | 廃止（`infra/types.ts` と `application/types.ts` に分割）|

## 新規作成ファイル

| ファイル | 内容 |
|----------|------|
| `domain/models/localDocument.ts` | ローカルファイルのドメインモデル |
| `domain/models/difyDocument.ts` | Difyドキュメントのドメインモデル |
| `domain/models/syncResult.ts` | 同期結果のドメインモデル |
| `infra/types.ts` | Dify APIレスポンス型、クライアントオプション型 |
| `application/types.ts` | 設定ファイル型（SyncConfig等）、DTO |

## テスト戦略

### テストの種類と対象

| テスト種別 | 対象層 | 特徴 |
|-----------|--------|------|
| **unit** | domain, application | 外部依存なし、infraはモック |
| **integration** | infra | 実際のDify APIと通信 |
| **e2e** | 全体 | 今回の変更対象外 |

### テストディレクトリ構成

```
scripts/test/
├── unit/
│   ├── domain/
│   │   ├── models/
│   │   │   ├── localDocument.test.ts
│   │   │   ├── difyDocument.test.ts
│   │   │   └── syncResult.test.ts
│   │   └── services/
│   │       └── documentDiffService.test.ts
│   └── application/
│       ├── syncUsecase.test.ts
│       └── importDslUsecase.test.ts
├── integration/
│   └── infra/
│       ├── difyKnowledgeClient.test.ts
│       └── difyConsoleClient.test.ts
└── e2e/
    └── (対象外)
```

### 各テスト種別の方針

**unit テスト（domain層）**
- 純粋なビジネスロジックのテスト
- 外部依存なし
- ドメインモデルのメソッド、ドメインサービスの計算ロジックを検証

**unit テスト（application層）**
- infra層（クライアント）をモックして実行
- ファイルI/Oもモック可能
- ユースケースのオーケストレーションロジックを検証

**integration テスト（infra層）**
- 実際のDify APIと通信
- APIレスポンスの形式、リトライ処理、エラーハンドリングを検証
- CI環境ではDifyコンテナを起動して実行

## テストファイルの変更

| 変更前 | 変更後 |
|--------|--------|
| `test/unit/client/knowledge.test.ts` | `test/integration/infra/difyKnowledgeClient.test.ts` |
| `test/unit/usecase/diff.test.ts` | `test/unit/domain/services/documentDiffService.test.ts` |
| `test/unit/usecase/sync.test.ts` | `test/unit/application/syncUsecase.test.ts` |
| `test/unit/usecase/import-dsl.test.ts` | `test/unit/application/importDslUsecase.test.ts` |

## 移行手順

1. `domain/models/` ディレクトリを作成し、ドメインモデルを実装
2. `domain/services/` ディレクトリを作成し、`diff.ts` のロジックを移動・リファクタ
3. `client/` → `infra/` にディレクトリ名変更、ファイル名も変更
4. `infra/types.ts` を作成し、Dify API関連の型を移動
5. `usecase/` → `application/` にディレクトリ名変更、ファイル名も変更し、domain層を使うようにリファクタ
6. `application/types.ts` を作成し、設定ファイル型・DTOを移動
7. ルートの `types.ts` を削除
8. テストファイルを対応するパスに移動・修正
9. `dify-cli.ts` のimportパスを更新
